# OpenVPN server config file
#
# Generated by Chef - local changes will be overwritten

port <%= node["openvpn"]["port"] %>
proto <%= node["openvpn"]["proto"] %>
<% if node["openvpn"]["type"] == "server-bridge" -%>
dev tap
<% else -%>
dev tun
<% end -%>
keepalive 5 20
comp-lzo
local <%= node["openvpn"]["local"] %>

<% if node['openvpn']['routes'] -%>
<% node["openvpn"]["routes"].each do |route| -%>
<%= route %>
<% end -%>
<% end -%>

<% if node['openvpn']['push'] %>
  push "redirect-gateway"
<% end %>
push "dhcp-option DNS 8.8.8.8"

<% if node['openvpn']['script_security'] > 1 -%>
up /etc/openvpn/server.up.sh
<% end -%>

# Keys and certificates.
ca   /etc/openvpn/keys/ca.crt
key  /etc/openvpn/keys/server.key # This file should be kept secret.
cert /etc/openvpn/keys/server.crt
dh   /etc/openvpn/keys/dh<%= node["openvpn"]["key"]["size"] %>.pem

ifconfig-pool-persist /etc/openvpn/ipp.txt

<% if node["openvpn"]["type"] == "server" -%>
<%= node["openvpn"]["type"] %> <%= node["openvpn"]["subnet"] %> <%= node["openvpn"]["netmask"] %>
<% end -%>

user <%= node["openvpn"]["user"] %>
group <%= node["openvpn"]["group"] %>

# avoid accessing certain resources on restart
persist-key
persist-tun

# current client connections
status /etc/openvpn/openvpn-status.log <%= node["openvpn"]["status_refresh_interval"] %>

# logging settings.
log-append  <%= node["openvpn"]["log"] %>
verb 1  # don't spam the log with messages.
mute 10 # suppress identical messages > 10 occurances.
reneg-sec 86400

auth-user-pass-verify openvpn-authenticate via-file
client-cert-not-required
username-as-common-name
tmp-dir /dev/shm

client-disconnect openvpn-disconnect
client-connect openvpn-connect

script-security 3 system
